// Prisma Schema for Blog System
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Blog {
  id         Int      @id @default(autoincrement())
  title      String
  slug       String   @unique
  content    String // Markdown content
  keywords   String // Comma-separated keywords for SEO
  categories String // Comma-separated categories
  featured   Boolean  @default(false)
  published  Boolean  @default(false)
  viewCount  Int      @default(0) // Denormalized counter — avoids COUNT(*) on BlogView
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  views      BlogView[]

  // Composite index: covers WHERE published = true ORDER BY featured DESC, createdAt DESC
  // Replaces the old individual indexes on published, featured, and slug (slug already covered by @unique)
  @@index([published, featured(sort: Desc), createdAt(sort: Desc)])
}

model BlogView {
  id        Int      @id @default(autoincrement())
  blogId    Int
  blog      Blog     @relation(fields: [blogId], references: [id], onDelete: Cascade)
  ipAddress String
  userAgent String
  viewedAt  DateTime @default(now())

  // Deduplicate by IP only — same IP with different browser = same person
  // This unique constraint also serves as an index for blogId lookups (leftmost prefix)
  @@unique([blogId, ipAddress])
}